<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ClayAlert Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; max-width:900px; margin:20px auto; padding:10px; }
    label{display:block;margin-top:12px;font-weight:600}
    input[type=text], textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:6px}
    .row { display:flex; gap:12px; align-items:center }
    .small { width:120px }
    button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:white;margin-top:12px }
    .muted{ color:#666; font-size:0.9em }
    .checkboxes{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .card{border:1px solid #eee;padding:12px;border-radius:8px;margin-top:12px;background:#fafafa}
  </style>
</head>
<body>
  <h1>ClayAlert Control Panel</h1>
  <p class="muted">Edit settings for the cloud ClayAlert system. This page saves a JSON file inside a GitHub Gist.</p>

  <div class="card">
    <label>Gist ID (config file location)</label>
    <input id="gistId" type="text" placeholder="Gist ID (example: 012345abcdef...)" />

    <label>Gist Filename</label>
    <input id="gistFilename" type="text" value="clay_alert_config.json" />

    <label>Emails (comma-separated)</label>
    <input id="emails" type="text" placeholder="gf1aoy...@gw.notify.events, member@example.com" />

    <label>NWS Zones (comma-separated)</label>
    <input id="zones" type="text" placeholder="TXZ213,TXZ237" />

    <label>Alert Types (comma-separated — or 'All')</label>
    <input id="alertTypes" type="text" placeholder="Tornado,Severe Thunderstorm,Flood,Tropical,All" />

    <div style="margin-top:10px">
      <label><input id="includeTropical" type="checkbox" /> Include Tropical Alerts</label>
    </div>

    <div style="margin-top:10px">
      <label>Tropical Lifecycle Notification Settings</label>
      <div class="checkboxes">
        <label><input id="l_formed" type="checkbox" /> Formed</label>
        <label><input id="l_upgrade" type="checkbox" /> Upgraded</label>
        <label><input id="l_downgrade" type="checkbox" /> Downgraded</label>
        <label><input id="l_dissipate" type="checkbox" /> Dissipated</label>
      </div>
    </div>

    <label>Tropical feed URL (optional)</label>
    <input id="tropicalFeed" type="text" placeholder="Optional feed URL for NHC JSON" />

    <div style="margin-top:12px" class="row">
      <div style="flex:1">
        <label>When saving, enter GitHub Personal Access Token (only needed to SAVE)</label>
        <input id="githubToken" type="text" placeholder="ghp_xxx (never share this)" />
        <div class="muted">Token must have 'gist' scope to edit the gist.</div>
      </div>
      <div style="width:200px">
        <label>&nbsp;</label>
        <button id="saveBtn">Save Settings to Gist</button>
      </div>
    </div>

    <div style="margin-top:14px">
      <button id="loadBtn">Load Current Settings</button>
      <button id="showJsonBtn">Show JSON</button>
    </div>

    <pre id="jsonOutput" style="display:none; margin-top:12px; padding:10px; background:#fff; border-radius:6px; border:1px solid #eee; max-height:340px; overflow:auto"></pre>
  </div>

  <script>
    const gistApi = (id) => `https://api.github.com/gists/${id}`;

    async function loadConfig() {
      const gistId = document.getElementById("gistId").value.trim();
      const filename = document.getElementById("gistFilename").value || "clay_alert_config.json";
      if (!gistId) { alert("Enter Gist ID first"); return; }
      try {
        const resp = await fetch(gistApi(gistId), {headers: {Accept: "application/vnd.github+json"}});
        if (!resp.ok) throw new Error("Failed to fetch gist: " + resp.status);
        const data = await resp.json();
        const files = data.files || {};
        if (!files[filename]) {
          // show default empty config
          setFormFromConfig({});
          alert("Filename not found in gist; a new file will be created when you save.");
          return;
        }
        const content = files[filename].content || "{}";
        const cfg = JSON.parse(content);
        setFormFromConfig(cfg);
        document.getElementById("jsonOutput").textContent = JSON.stringify(cfg, null, 2);
      } catch (e) {
        alert("Load failed: " + e);
        console.error(e);
      }
    }

    function setFormFromConfig(cfg) {
      document.getElementById("emails").value = (cfg.emails || []).join(", ");
      document.getElementById("zones").value = (cfg.zones || []).join(", ");
      document.getElementById("alertTypes").value = (cfg.alert_types || []).join(", ") || "All";
      document.getElementById("includeTropical").checked = !!cfg.include_tropical;
      const lifecycle = cfg.tropical_lifecycle || {formed:true,upgrade:true,downgrade:true,dissipate:true};
      document.getElementById("l_formed").checked = !!lifecycle.formed;
      document.getElementById("l_upgrade").checked = !!lifecycle.upgrade;
      document.getElementById("l_downgrade").checked = !!lifecycle.downgrade;
      document.getElementById("l_dissipate").checked = !!lifecycle.dissipate;
      document.getElementById("tropicalFeed").value = cfg.tropical_feed_url || "";
    }

    function buildConfigFromForm() {
      const emails = document.getElementById("emails").value.split(",").map(s=>s.trim()).filter(Boolean);
      const zones = document.getElementById("zones").value.split(",").map(s=>s.trim()).filter(Boolean);
      const alert_types = document.getElementById("alertTypes").value.split(",").map(s=>s.trim()).filter(Boolean);
      const include_tropical = document.getElementById("includeTropical").checked;
      const tropical_lifecycle = {
        formed: document.getElementById("l_formed").checked,
        upgrade: document.getElementById("l_upgrade").checked,
        downgrade: document.getElementById("l_downgrade").checked,
        dissipate: document.getElementById("l_dissipate").checked
      };
      const tropical_feed_url = document.getElementById("tropicalFeed").value.trim();
      return {
        emails, zones, alert_types, include_tropical, tropical_lifecycle, tropical_feed_url
      };
    }

    async function saveConfigToGist() {
      const gistId = document.getElementById("gistId").value.trim();
      const filename = document.getElementById("gistFilename").value || "clay_alert_config.json";
      const token = document.getElementById("githubToken").value.trim();
      if (!gistId) { alert("Gist ID required"); return; }
      if (!token) {
        if (!confirm("No GitHub token provided — you cannot save without a token. Create a token with 'gist' scope. Proceed?")) return;
      }
      const cfg = buildConfigFromForm();
      const payload = { files: {} };
      payload.files[filename] = { content: JSON.stringify(cfg, null, 2) };

      try {
        const resp = await fetch(gistApi(gistId), {
          method: "PATCH",
          headers: {
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json",
            "Authorization": `token ${token}`
          },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error("Failed to save gist: " + resp.status + " " + txt);
        }
        alert("Saved config to gist successfully.");
      } catch (e) {
        alert("Save failed: " + e);
        console.error(e);
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadConfig);
    document.getElementById("saveBtn").addEventListener("click", saveConfigToGist);
    document.getElementById("showJsonBtn").addEventListener("click", ()=>{
      const cfg = buildConfigFromForm();
      const el = document.getElementById("jsonOutput");
      el.style.display = "block";
      el.textContent = JSON.stringify(cfg, null, 2);
    });

    // optionally auto-load if gist id prefilled
    (function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const gid = urlParams.get("gist");
      if (gid) {
        document.getElementById("gistId").value = gid;
        loadConfig();
      }
    })();
  </script>
</body>
</html>
